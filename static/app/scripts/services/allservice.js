"use strict";angular.module("weberApp").factory("InstanceSearch",function(e,d,c,a){var b=function(){this.InstancesearchResult=[];this.busy=false;this.end=false;this.page=1;this.query=null};b.prototype.getInstancePeoples=function(h){var f=this;this.query=h;if((h)){var g={method:"POST",url:"/api/getpeoplenames",headers:{"Content-Type":"application/json"},data:{page:this.page,query:h.toLowerCase()}};e(g).success(function(i){f.InstancesearchResult=i}.bind(f))}else{f.InstancesearchResult=[]}};b.prototype.nextPage=function(){if(this.busy|this.end){return}this.busy=true;var f=this;var g={method:"POST",url:"/api/getpeoplenames",headers:{"Content-Type":"application/json"},data:{page:f.page,query:f.query},};e(g).success(function(h){if(h.length===0){f.end=true}f.InstancesearchResult.push.apply(f.InstancesearchResult,h);f.page=f.page+1;f.busy=false}.bind(f))};return b}).service("UserService",function(b,a){this.users=[];this.get=function(d){for(var c in this.users){if(this.users[c]._id==d){return this.users[c]}}var e=a.one("people",d).get().$object;e._id=d;this.users.push(e);return e}}).service("InstanceSearchHistory",function(b,a){this.history=[];this.get=function(d){for(var c in this.history){if(this.history[c].query==d){return this.history[c].result}}return b.get("/api/getpeoplenames/"+d)};this.pushToHistory=function(d,c){this.history.push({query:c,result:d})}}).service("MatchButtonService",function(c,a,b){this.checkMatchUnMatch=function(f,d){for(var e in f.interestedPeople){if(f.interestedPeople[e].interested_person==d._id){return true}}return false};this.match=function(d,f,e){return a.one("match").get({cuserid:e,authorid:d,postid:f,seed:Math.random()})};this.unmatch=function(d,f,e){return a.one("unmatch").get({cuserid:e,authorid:d,postid:f,seed:Math.random()})}}).factory("InfinitePosts",function(e,c,b,a){var d=function(g,f){this.posts=[];this.SpecificPost={},this.user_obj=g;this.busy=true;this.page=1;this.loadPostIds=f;this.end=false;this.params='{"author": {"$in":'+this.loadPostIds+"}}"};d.prototype.getEarlyPosts=function(){c.all("posts").getList({where:this.params,max_results:10,page:this.page,sort:'[("_created",-1)]',seed:Math.random()}).then(function(f){if(f.length<10){this.end=true}this.posts.push.apply(this.posts,f);this.page=this.page+1;this.busy=false}.bind(this))};d.prototype.getSpecificPost=function(g){var f='{"author":1}';c.one("posts",g.postid).get({embedded:f,seed:Math.random()}).then(function(h){this.posts.push({_id:h._id,author:h.author,content:h.content,_created:h._created,_etag:h._etag,interestedPeople:h.interestedPeople,})}.bind(this))};d.prototype.nextPage=function(){if(this.busy|this.end){return}this.busy=true;c.all("posts").getList({where:this.params,max_results:10,page:this.page,sort:'[("_created",-1)]',seed:Math.random()}).then(function(f){if(f.length===0){this.end=true}this.posts.push.apply(this.posts,f);this.page=this.page+1;this.busy=false}.bind(this))};d.prototype.loadNotificPost=function(g,f){if(this.user_obj._id!==f){c.one("posts",g).get().then(function(h){this.posts.unshift({author:h.author,content:h.content,_created:h._created,_id:h._id,_etag:h._etag,interestedPeople:h.interestedPeople})}.bind(this))}};d.prototype.addPost=function(h,g,f){this.user_obj.all("posts").post({author:this.user_obj._id,content:h,keywords:g,post_image_path:f,interestedPeople:[]}).then(function(j){this.posts.unshift({author:this.user_obj._id,content:h,post_image_path:f,_created:new Date(),_id:j._id,_etag:j._etag,interestedPeople:[]});var i=b({title:"Successfully Posted! :)",placement:"top",type:"success",show:true});a(function(){i.hide()},5000)}.bind(this))};d.prototype.deletePost=function(h,f){c.one("posts",h._id).remove({},{"If-Match":(h._etag).toString()}).then(function(j){for(var i in this.posts){if(this.posts[i]._id==h._id){this.posts.splice(i,1);this.SpecificPost={}}}}.bind(this));for(var g in h.author.matchnotifications){if(h.author.matchnotifications[g].postid==h._id){h.author.matchnotifications.splice(g,1);f.patch({matchnotifications:h.author.matchnotifications}).then(function(i){})}}};return d}).service("PostService",function(c,a){this.posts=[];var b='{"author":1}';this.get=function(f){for(var d in this.posts){if(this.posts[d]._id==f){return this.posts[d]}}var e=a.one("posts",f).get({embedded:b,seed:Math.random()}).$object;e._id=f;this.posts.push(e);return e};this.resetPost=function(e){var d=a.one("posts",e).get({embedded:b,seed:Math.random()}).$object;d._id=e;this.posts.push(d);return d}}).service("sortIListService",function(c,a,b){this.sendList=function(f,e){if(f&&f.length){for(var d in f){if(f[d]==e){f.push(f.splice(d,1)[0])}}return f.reverse()}else{return f}}}).service("CurrentUser1",function(b,a){this.userId=null;this.user=null;this.reset=function(){this.userId=null};if(this.userId===null){b.get("/api/me",{headers:{"Content-Type":"application/json"}}).success(function(c){this.userId=c;a.one("people",JSON.parse(c)).get().then(function(d){this.user=d}.bind(this))}.bind(this))}}).factory("CurrentUser",function(e,b,a,d){var c=function(){this.userId=null;this.user=null};c.prototype.getUserId=function(){return e.get("/api/me",{headers:{"Content-Type":"application/json",Authorization:b.getToken()}}).success(function(f){this.userId=f}.bind(this))};c.prototype.getCUserDetails=function(f){return d.one("people",JSON.parse(f)).get({seed:Math.random()})};return c}).service("ESClient",function(a){return a({host:"http://127.0.0.1:8000",apiVersion:"1.2",log:"trace"})}).factory("SearchActivity",function(f,c,b,a){var d=function(g){this.searchResult=[];this.user_obj=g;this.busy=false;this.end=false;this.page=1};d.prototype.getMysearches=function(){this.user_obj.all("searchActivity").getList({max_results:10,page:this.page,sort:'[("_created",-1)]',seed:Math.random()}).then(function(g){if(g.length<10){this.end=true}this.searchResult.push.apply(this.searchResult,g);this.page=this.page+1;this.busy=false}.bind(this))};d.prototype.nextPage=function(){if(this.busy|this.end){return}this.busy=true;this.user_obj.all("searchActivity").getList({max_results:2,page:this.page,sort:'[("_created",-1)]',seed:Math.random()}).then(function(g){if(g.length===0){this.end=true}this.searchResult.push.apply(this.searchResult,g);this.page=this.page+1;this.busy=false}.bind(this))};d.prototype.addSearchText=function(h,g){this.user_obj.all("searchActivity").post({author:this.user_obj._id,content:h,keywords:g}).then(function(i){this.searchResult.unshift({author:this.user_obj._id,content:h,_id:i._id})}.bind(this))};d.prototype.getSimilarWords=function(g){return f({url:"/api/similarwords",method:"GET",params:{querystring:g}})};function e(g){return(g.length?'"'+g.join('","')+'"':"")}return d}).factory("MatchMeResults",function(h,i,e,c,g,a,f){function d(k){return(k.length?'"'+k.join('","')+'"':"")}function j(l){var m=[];var k=[];for(var n in l){if(k.indexOf(l[n].author._id)===-1){k.push(l[n].author._id);m.push(l[n])}}return m}var b=function(l){this.total_matches=0;this.mResultsNotFound=false;this.saResultsNotFound=false;this.mresults=[];this.matchedids=[];this.totalNames="";this.searchNames=[];this.busy=true;this.page=1;this.end=false;var k;this.param1=null;this.param2=null;this.query=l;this.sPage=1;this.sEnd=false;this.sBusy=true;this.suggestpeople=false};b.prototype.newSearchResults=function(){if(this.query){var l=d(this.query.split(" "));var k=this;this.param1='{"$or":[{"keywords": {"$in":['+l+']}},{"content":{"$regex":".*'+this.query+'.*"}}]}';this.param2='{"author":1}';i.all("posts").getList({where:k.param1,seed:Math.random(),max_results:70,page:k.page,embedded:k.param2}).then(function(m){if(m.length<70){k.end=true}if(m.length==0){k.mResultsNotFound=true}k.mresults.push.apply(k.mresults,m);k.mresults=j(k.mresults);k.total_matches=m.length;k.page=k.page+1;k.busy=false}.bind(this));this.param1='{"$or":[{"keywords": {"$in":['+l+']}},{"content":{"$regex":".*'+this.query+'.*"}}]}';this.param2='{"author":1}';i.all("searchActivity").getList({where:this.param1,seed:Math.random(),max_results:70,page:this.sPage,embedded:this.param2}).then(function(m){if(m.length<70){this.sEnd=true}if(m.length==0){k.saResultsNotFound=true}this.mresults.push.apply(this.mresults,m);k.mresults=j(k.mresults);this.total_matches=this.total_matches+m.length;this.sPage=this.sPage+1;this.sBusy=false}.bind(this))}};b.prototype.getMatchedNewResults=function(k){var m='{"_id":"'+k+'"}';var l=i.one("people",JSON.parse(f.userId)).all("searchActivity").getList({where:m,sort:'[("_created",-1)]',seed:Math.random()}).then(function(n){var p='{"_id":{"$in":['+d(n[0].matchedPosts)+"]}}";var o='{"author":1}';var q=i.all("posts").getList({where:p,embedded:o,seed:Math.random()}).then(function(r){this.total_matches=r.length;this.mresults.push.apply(this.mresults,r)}.bind(this));i.one("searchActivity",k).patch({newResults:0},{},{"Content-Type":"application/json","If-Match":n[0]._etag,Authorization:a.getToken()});return q}.bind(this));return l};b.prototype.nextPage=function(){if((this.busy|this.end)&&this.query){return}this.busy=true;var k=this;i.all("posts").getList({where:k.param1,max_results:70,page:k.page,embedded:k.param2}).then(function(l){if(l.length===0){k.end=true}k.mresults.push.apply(k.mresults,l);k.mresults=j(k.mresults);k.page=k.page+1;k.busy=false}.bind(k))};b.prototype.nextPageSearchResults=function(){if((this.sBusy|this.sEnd)&&this.query){return}this.sBusy=true;var k=this;i.all("searchActivity").getList({where:k.param1,max_results:70,page:k.sPage,embedded:k.param2}).then(function(l){if(l.length===0){k.sEnd=true}k.mresults.push.apply(k.mresults,l);k.mresults=j(k.mresults);k.sPage=k.sPage+1;k.sBusy=false}.bind(k))};b.prototype.getMatchPeoples=function(k){var l='{"$or":[{"name.first":{"$regex":".*'+k+'.*"}},{"name.last":{"$regex":".*'+k+'.*"}},{"username":{"$regex":".*'+k+'.*"}}]}';i.all("people").getList({where:l}).then(function(m){this.totalNames=m.length;this.searchNames.push.apply(this.searchNames,m)}.bind(this))};b.prototype.getSuggestedPeople=function(){function l(m){return(m.length?'"'+m.join('","')+'"':"")}var k='{"interestsimilarwords":{"$in":['+l(this.query.split(" "))+"]}}";i.all("people").getList({where:k,seed:Math.random()}).then(function(p){if(p.length>=1){this.suggestpeople=true}var m=[];this.mresults.push.apply(this.mresults,p);for(var n in this.mresults){var o={author:{name:{first:this.mresults[n].name.first,last:this.mresults[n].name.last,},_id:this.mresults[n]._id,picture:{medium:this.mresults[n].picture.medium}}};m.push(o)}this.mresults=m}.bind(this))};return b});